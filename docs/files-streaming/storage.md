# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞

## 1. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –Ω–∞ Gateway (NestJS)

### –ò–Ω—Ç–µ—Ä—Ü–µ–ø—Ç–æ—Ä StreamingFileInterceptor

- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ Content-Type.
- –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ multipart/form-data, –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ.
- –≠—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∞—Ç–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã –Ω–∞ –ø–∞—Ä—Å–∏–Ω–≥ –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤.

### –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä uploadAvatar

- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç `req: Request` –Ω–∞–ø—Ä—è–º—É—é, –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `@UploadedFile()` –∏–ª–∏ multer.
- –ü–µ—Ä–µ–¥–∞—ë—Ç –∑–∞–ø—Ä–æ—Å –≤ —Å–µ—Ä–≤–∏—Å `profileAuthClientService.uploadAvatarStreaming`, –≥–¥–µ —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Å—Ç—Ä–∏–º.

## 2. Gateway —Å–µ—Ä–≤–∏—Å ‚Üí –ø–∞—Ä—Å–∏–Ω–≥ multipart

–í `StreamClientService.streamFilesToService`:

- –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è busboy –∏ "–ø–æ–¥–≤–µ—à–∏–≤–∞–µ—Ç—Å—è" –Ω–∞ –≤—Ö–æ–¥—è—â–∏–π `req.pipe(bb)`.
- Busboy —Ä–∞–∑–±–∏—Ä–∞–µ—Ç multipart/form-data —Å—Ç—Ä–∏–º–æ–º: –∏–∑–≤–ª–µ–∫–∞–µ—Ç –ø–æ–ª—è —Ñ–æ—Ä–º—ã –∏ —Ñ–∞–π–ª—ã –ø–æ —á–∞–Ω–∫–∞–º.

–í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ `bb.on("file")`:

- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∏–º—è –ø–æ–ª—è, —Ä–∞–∑–º–µ—Ä, MIME —Ç–∏–ø.
- –ï—Å–ª–∏ —Ñ–∞–π–ª –≤–∞–ª–∏–¥–Ω—ã–π ‚Äî –æ–Ω –Ω–µ –±—É—Ñ–µ—Ä–∏–∑—É–µ—Ç—Å—è, –∞ —Å—Ä–∞–∑—É —É—Ö–æ–¥–∏—Ç –≤ `streamSingleFile`, –≥–¥–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è TCP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ —Ñ–∞–π–ª–æ–≤–æ–º—É –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—É.

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º:

- Gateway –Ω–µ —Ö—Ä–∞–Ω–∏—Ç –≤–µ—Å—å —Ñ–∞–π–ª –≤ –ø–∞–º—è—Ç–∏.
- –ö–∞–∂–¥—ã–π —Ñ–∞–π–ª —Å—Ä–∞–∑—É –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –¥–∞–ª—å—à–µ –ø–æ —Å–µ—Ç–∏.

## 3. Gateway ‚Üí Files microservice (TCP streaming)

### –ú–µ—Ç–æ–¥ streamSingleFile:

- –°–æ–∑–¥–∞—ë—Ç TCP-—Å–æ–∫–µ—Ç `net.connect(...)` –∫ —Ñ–∞–π–ª–æ–≤–æ–º—É —Å–µ—Ä–≤–∏—Å—É.
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç JSON-–∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ (–∏–º—è —Ñ–∞–π–ª–∞, MIME, —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è —Ä–µ—Å–∞–π–∑–∞, –ø–∞–ø–∫–∞).
- –ó–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —Å–∏–º–≤–æ–ª–æ–º `\n`, —á—Ç–æ–±—ã —Å–µ—Ä–≤–µ—Ä –º–æ–≥ –æ—Ç–¥–µ–ª–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ—Ç –±–∏–Ω–∞—Ä–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞.
- –ü–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –ø–∞–π–ø–∏—Ç –≤—Ö–æ–¥—è—â–∏–π —Ñ–∞–π–ª–æ–≤—ã–π —Å—Ç—Ä–∏–º (`fileStream`) –≤ —Å–æ–∫–µ—Ç.
- –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞—Å—Ç–æ—è—â–∏–π "–ø—Ä–æ–∫—Å–∏ —Å—Ç—Ä–∏–º–∞".
- –ù–∞ `end` ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–∫–µ—Ç, –æ–∂–∏–¥–∞–µ—Ç –æ—Ç–≤–µ—Ç.
- –ù–∞ `data/close` ‚Äî –ø–æ–ª—É—á–∞–µ—Ç JSON-–æ—Ç–≤–µ—Ç –æ—Ç –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞ –æ–± —É—Å–ø–µ—à–Ω–æ–π/–Ω–µ—É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ.

## 4. Files microservice (TCP server)

### –ö–ª–∞—Å—Å StreamingServer:

- –ü–æ–¥–Ω–∏–º–∞–µ—Ç TCP-—Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ `net.createServer`.
- –ü—Ä–∏ –Ω–æ–≤–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ (`handleConnection`):
  - –ü–µ—Ä–≤—ã–º –ø–∞–∫–µ—Ç–æ–º –∂–¥—ë—Ç JSON-–∑–∞–≥–æ–ª–æ–≤–æ–∫ (–¥–æ `\n`).
  - –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å –±–∞–π—Ç–æ–≤—ã–π –ø–æ—Ç–æ–∫ —Ñ–∞–π–ª–∞.

## 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞ (—Ä–µ—Å–∞–π–∑ –∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è)

### –ú–µ—Ç–æ–¥ processStream:

- –°–æ–∑–¥–∞—ë—Ç PassThrough –ø–æ—Ç–æ–∫ –¥–ª—è –ø—Ä–∏–Ω—è—Ç—ã—Ö –±–∞–π—Ç–æ–≤.
- –ù–∞ –∫–∞–∂–¥—ã–π `data` –æ—Ç —Å–æ–∫–µ—Ç–∞ ‚Üí –ø–∏—à–µ—Ç –≤ `passThrough`.
- –°–æ–∑–¥–∞—ë—Ç –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ–º—É sharp-—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 200x200, 400x400).
- sharp —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Ç–æ–∫–æ–≤–æ: –ø–æ–ª—É—á–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ –±–∞–π—Ç—ã –∏ —Å—Ä–∞–∑—É –ø–∏—à–µ—Ç —Å–∂–∞—Ç—ã–π WebP –≤ –≤—ã—Ö–æ–¥–Ω–æ–π —Å—Ç—Ä–∏–º.
- –ß–µ—Ä–µ–∑ `stream.pipe(sharp()).pipe(s3UploadStream)` –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤ S3.

## 6. –ó–∞–≥—Ä—É–∑–∫–∞ –≤ S3

### –ö–ª–∞—Å—Å StorageAdapter:

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `@aws-sdk/lib-storage` Upload —Å PassThrough.
- S3 –∫–ª–∏–µ–Ω—Ç –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–æ—Ç–æ–∫ –∫–∞–∫ Body.
- AWS SDK —Å–∞–º —Ä–µ–∂–µ—Ç –ø–æ—Ç–æ–∫ –Ω–∞ —á–∞–Ω–∫–∏ (–ø–æ 5MB) –∏ –≥—Ä—É–∑–∏—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (`queueSize=4`).
- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.

## 7. –û—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É

- –ö–æ–≥–¥–∞ –≤—Å–µ –≤–µ—Ä—Å–∏–∏ —Ñ–∞–π–ª–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã ‚Üí —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è DTO —Å URL, —Ä–∞–∑–º–µ—Ä–∞–º–∏ –∏ –≤–µ—Å–æ–º.
- –°–µ—Ä–≤–µ—Ä TCP (`StreamingServer`) –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç JSON-–æ—Ç–≤–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ —á–µ—Ä–µ–∑ —Å–æ–∫–µ—Ç.
- Gateway (`streamSingleFile`) –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Å–µ—Ä–≤–∏—Å `profileAuthClientService`.
- –°–µ—Ä–≤–∏—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–∞–ø–∏—Å—å –æ —Ñ–∞–π–ª–µ –≤ –ë–î –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—É.
- –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –æ—Ç–¥–∞—ë—Ç HTTP-–æ—Ç–≤–µ—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É.

## üìå –í–∞–∂–Ω—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –º–æ–º–µ–Ω—Ç—ã:

### –§–∞–π–ª –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—É—Ñ–µ—Ä–∏–∑—É–µ—Ç—Å—è —Ü–µ–ª–∏–∫–æ–º:

```
–§—Ä–æ–Ω—Ç ‚Üí Gateway ‚Üí TCP ‚Üí Files service ‚Üí S3 = –≤—Å–µ–≥–¥–∞ —Å—Ç—Ä–∏–º—ã.
```

### –ö–æ–Ω—Ç—Ä–æ–ª—å –æ—à–∏–±–æ–∫:

- Gateway –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ busboy (—Ä–∞–∑–º–µ—Ä, mime).
- –°–æ–∫–µ—Ç –∏–º–µ–µ—Ç —Ç–∞–π–º–∞—É—Ç (60—Å).
- Files —Å–µ—Ä–≤–∏—Å –æ—Ç–ª–∞–≤–ª–∏–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ sharp –∏–ª–∏ S3.
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤ S3: SDK –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–±–∏–≤–∞–µ—Ç –ø–æ—Ç–æ–∫.

### –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:

- Gateway –º–æ–∂–Ω–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ.
- Files service –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—Ç–æ–∫ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ, –º–æ–∂–µ—Ç —Å–∞–º –±—ã—Ç—å –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ.
- S3 ‚Äî —É–∂–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.