// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
  url      = env("AUTH_POSTGRES_URL")
}

// Модель пользователя - таблица в БД
model User {
  id String @id @default(uuid())
  email String  @unique
  createdAt DateTime @default(now())
  passwordHash String?
  confirmationCode String? @unique
  confirmationCodeConfirmed Boolean @default(false)
	confirmationCodeExpDate DateTime?
  recoveryCode String? @unique
  recoveryCodeExpDate DateTime?
  googleUserId String? 
  githubUserId String? @unique
	deletedAt DateTime?
	isPremium Boolean @default(false)
	premiumUntil	DateTime?

  sessions Session[]  // обратная сторона связи
	profile Profile?

  @@map("users")  
}

model Session {
  deviceId String @id @unique
  userId String 
  deviceName String
  iat DateTime
  exp DateTime
  ip String
	country String?
	city String?
	latitude Float?
	longitude Float?
	timezone String?
	browser String?
	os String?
	type String?
	userAgent String?
  deletedAt DateTime?
	createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@map("sessions")
}


model TokensBlacklist {
  id String @id @default(uuid())
  token String
  createdAt DateTime @default(now())
	expiredAt DateTime
  @@map("blacklist")
}

model Profile {
  id String @id @default(uuid())
  userId String @unique
  userName String @unique
  firstName String?
  lastName String?
  city String?
  country String?
  region String?
  dateOfBirth DateTime?
  aboutMe String?
  createdAt DateTime @default(now())
	deletedAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

enum InboxStatus {
  RECEIVED
  PROCESSED
  FAILED
}

model InboxMessage {
  id           String      @id            // messageId из брокера / eventId из webhooks
  type         String
  source       String                      // "payments-service" | "stripe" и т.п.
  payload      Json
  status       InboxStatus @default(RECEIVED)
  error        String?
  receivedAt   DateTime    @default(now())
  processedAt  DateTime?

  @@map("inbox_messages")
  @@index([status])
  @@index([source, type])
}
