// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
  url      = env("AUTH_POSTGRES_URL")
}

// Модель пользователя - таблица в БД
model User {
  id String @id @default(uuid())
  email String  @unique
  createdAt DateTime @default(now())
  passwordHash String?
  confirmationCode String? @unique
  confirmationCodeConfirmed Boolean @default(false)
	confirmationCodeExpDate DateTime?
  recoveryCode String? @unique
  recoveryCodeExpDate DateTime?
	premiumExpDate DateTime?
  googleUserId String? 
  githubUserId String? @unique
	deletedAt DateTime?
	isBlocked Boolean @default(false)
	blockedAt DateTime?
	blockedReason String?

  followers            Follow[]              @relation(name: "followers")
  followings           Follow[]              @relation(name: "followings")

  sessions Session[]  // обратная сторона связи
	profile Profile?

  @@map("users")  
}

model Session {
  deviceId String @id @unique
  userId String 
  deviceName String
  iat DateTime
  exp DateTime
  ip String
	country String?
	city String?
	latitude Float?
	longitude Float?
	timezone String?
	browser String?
	os String?
	type String?
	userAgent String?
  deletedAt DateTime?
	createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@map("sessions")
}


model TokensBlacklist {
  id String @id @default(uuid())
  token String
  createdAt DateTime @default(now())
	expiredAt DateTime
  @@map("blacklist")
}

model Profile {
  id String @id @default(uuid())
  userId String @unique
  userName String @unique
  firstName String?
  lastName String?
  city String?
  country String?
  region String? // TODO: remove this field
  dateOfBirth DateTime?
  aboutMe String?
  createdAt DateTime @default(now())
	deletedAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

model OutboxEvent {
  id             String       @id @default(uuid())
  // Для маршрутизации/реплея:
  aggregateType  String       // "subscription" | "transaction" | "user"
  eventType      String       // "SubscriptionActivated" | "PaymentSucceeded" ...
  payload        Json
  headers        Json?
  status         OutboxStatus @default(PENDING)
  attempts       Int          @default(0)
  nextAttemptAt  DateTime?
  topic          String?      // опционально: имя топика/роутинга
  createdAt      DateTime     @default(now())
  publishedAt    DateTime?

  @@map("outbox_events")
}

/**
 * INBOX: фиксация входящих сообщений (webhooks/команды/события) для идемпотентной обработки.
 * Если messageId уже есть — повтор не обрабатываем.
 */
model InboxEvent {
  id            String      @id                 // используйте messageId из брокера/вебхука
  type          String
  source        String                           // "stripe", "paypal", "auth-service", ...
  payload       Json
  status        InboxStatus  @default(RECEIVED)
  error         String?
  receivedAt    DateTime     @default(now())
  processedAt   DateTime?

  @@map("inbox_events")
}

enum OutboxStatus {
  PENDING
  PUBLISHED
  FAILED
}

enum InboxStatus {
  RECEIVED
  PROCESSED
  FAILED
}

model Follow {
  id String @id @default(uuid())

  follower   User   @relation(name: "followers", fields: [followerId], references: [id], onDelete: Cascade)
  followerId String @map("follower_id")

  following   User   @relation(name: "followings", fields: [followingId], references: [id], onDelete: Cascade)
  followingId String @map("following_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("follows")
}